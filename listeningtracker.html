<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listening Tracker</title>
<style>
  :root {
    --bg:#ffffff; --text:#000; --muted:#555;
    --primary:#007bff; --finish:#ff8800; --card:#fafafa; --level:#4CAF50;
  }
  html, body {
    margin:0; height:100%; background:var(--bg); color:var(--text);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .screen { display:none; min-height:100%; display:flex; align-items:center; justify-content:center; }
  .wrap {
    width:min(720px,92vw); background:var(--card); border:1px solid #eee;
    border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.08);
  }
  h1 { margin:0 0 12px; font-size:1.4rem; }
  p { margin:.2rem 0 .8rem; color:var(--muted); }
  input[type=text], input[type=file] {
    width:100%; padding:12px 14px; font-size:16px; border:1px solid #ccc; border-radius:10px;
  }
  button {
    border:none; border-radius:12px; padding:14px 0; font-size:16px; cursor:pointer; font-weight:600;
  }
  .btn-speed { background:var(--primary); color:#fff; }
  .btn-start { background:#007bff; color:#fff; width:300px; font-size:1.6rem; padding:18px 0; }
  .btn-finish { background:var(--finish); color:#fff; }
  .btn-level { background:var(--level); color:#fff; padding:10px 12px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .mt { margin-top:12px; }
  audio { width:100%; margin:12px 0 8px; }
  .grid { display:grid; gap:10px; grid-template-columns: repeat(4, 1fr); }
  @media (max-width:560px){ .grid { grid-template-columns: repeat(3, 1fr);} }
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen" style="display:flex">
  <div class="wrap">
    <h1>Listening Tracker</h1>
    <p>Paste an <b>MP3 file URL</b>. This site logs listening events and downloads a CSV.</p>
    <div class="row">
      <input id="mp3Url" type="text" placeholder="https://example.com/file.mp3" style="flex:1;" />
    </div><br>
    <p><b>OR </b>upload a <b>local MP3 file</b>.</p>
    <div class="row">
      <input id="mp3File" type="file" accept=".mp3,audio/mpeg" />
    </div>

    <!-- Student # + Level buttons (placeholders fill the URL box) -->
    <div class="row mt">
      <input id="studentId" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Student # (optional)" style="flex:1;" />
      <button class="btn-level" data-level="A1" type="button">A1</button>
      <button class="btn-level" data-level="A2" type="button">A2</button>
      <button class="btn-level" data-level="B1" type="button">B1</button>
      <button class="btn-level" data-level="B2" type="button">B2</button>
      <button class="btn-level" data-level="C1" type="button">C1</button>
      <button class="btn-level" data-level="C2" type="button">C2</button>
    </div>

    <div class="row" style="margin-top:1rem; justify-content:center;">
      <button id="startBtn" class="btn-start" disabled>Start</button>
    </div>
  </div>
</div>

<!-- PLAYER SCREEN -->
<div id="playerScreen" class="screen">
  <div class="wrap">
    <h1 id="title" style="margin-bottom:4px;">Player</h1>
    <p id="hint" style="margin-top:0; font-size:.95rem;"></p>
    <audio id="audio" controls></audio>
    <div class="grid mt" id="speedGrid">
      <button class="btn-speed" data-speed="0.5">0.5×</button>
      <button class="btn-speed" data-speed="0.75">0.75×</button>
      <button class="btn-speed" data-speed="1">1×</button>
      <button class="btn-speed" data-speed="1.25">1.25×</button>
      <button class="btn-speed" data-speed="1.5">1.5×</button>
      <button class="btn-speed" data-speed="1.75">1.75×</button>
      <button class="btn-speed" data-speed="2">2×</button>
      <button id="finishBtn" class="btn-finish">Finish</button>
    </div>
  </div>
</div>

<script>
/* ---------- Elements ---------- */
const startScreen = document.getElementById('startScreen');
const playerScreen = document.getElementById('playerScreen');
const urlInput = document.getElementById('mp3Url');
const fileInput = document.getElementById('mp3File');
const startBtn = document.getElementById('startBtn');
const audio = document.getElementById('audio');
const finishBtn = document.getElementById('finishBtn');
const hint = document.getElementById('hint');

/* ---------- State ---------- */
let studentTag = '';
let mp3Url = '';
let logRows = [];

let totalListen = 0;        // seconds of actual listening (only while playing)
let speedIntegral = 0;      // Σ(playbackRate * seconds) for weighted avg speed
let lastPlayT = null;       // ms when playback last started/resumed
let firstPlayAt = null;     // ms of the very first 'play'
let finishedAt = null;

let lastSeg = null;         // last 0.1s segment index seen while playing
let lastEventWasSeek = false;

// Unique listening segments at 0.1s resolution (store integer indices: floor(t*10))
const listenedSegments = new Set();

/* ---------- CSV header ---------- */
const HEADER = [
  "student_number","mp3_url","event_type","timestamp","audio_time_sec",
  "playback_speed","total_listen_time_sec","completion_percent"
];

/* ---------- Helpers ---------- */
function looksLikeMP3(u){
  try { const x = new URL(u); return x.pathname.toLowerCase().endsWith('.mp3'); }
  catch(e){ return false; }
}
function refreshStartDisabled(){
  const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
  const hasUrl  = looksLikeMP3(urlInput.value.trim());
  startBtn.disabled = !(hasFile || hasUrl);
}
urlInput.addEventListener('input', refreshStartDisabled);
fileInput.addEventListener('change', refreshStartDisabled);

// Level placeholders (valid .mp3-looking URLs so Start enables)
const LEVEL_PLACEHOLDERS = {
  A1:'PLACEHOLDER-A1.mp3',
  A2:'PLACEHOLDER-A2.mp3',
  B1:'PLACEHOLDER-B1.mp3',
  B2:'PLACEHOLDER-B2.mp3',
  C1:'PLACEHOLDER-C1.mp3',
  C2:'PLACEHOLDER-C2.mp3'
};
document.querySelectorAll('.btn-level').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const lv = btn.getAttribute('data-level');
    const url = LEVEL_PLACEHOLDERS[lv] || '';
    urlInput.value = url;
    if (fileInput) fileInput.value = ""; // ensure URL is used
    refreshStartDisabled();
  });
});

function nowTS(){
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function stampDigits(d=new Date()){
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}
function fmt(n){ return Number.isFinite(n) ? n.toFixed(2) : ""; }
function csvEscape(v){
  const s = String(v ?? "");
  if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
function pushLog(type){
  const at = audio.currentTime || 0;
  const dur = audio.duration || 0;
  const completionInstant = dur>0 ? (at/dur)*100 : 0;
  logRows.push([
    studentTag, mp3Url, type, nowTS(),
    fmt(at), fmt(audio.playbackRate||1),
    fmt(totalListen), fmt(completionInstant)
  ]);
}

// Accrue listening time only while actually playing
function accountListening(){
  if (firstPlayAt === null) return; // ignore anything before first Play
  if (lastPlayT !== null) {
    const now = Date.now();
    const delta = (now - lastPlayT)/1000;
    totalListen += delta;
    speedIntegral += delta * (audio.playbackRate || 1);
    lastPlayT = now;
  }
}

function startWithSource(src, label){
  mp3Url = label;
  audio.src = src;
  hint.textContent = label;
  startScreen.style.display = 'none';
  playerScreen.style.display = 'flex';
}

/* ---------- Start ---------- */
startBtn.addEventListener('click', ()=>{
  // establish student tag (entered or timestamp)
  const entered = (document.getElementById('studentId')?.value || '').trim();
  studentTag = entered || stampDigits(new Date());

  const file = fileInput?.files?.[0];
  const url  = urlInput.value.trim();
  if (file) {
    const objURL = URL.createObjectURL(file);
    startWithSource(objURL, `local:${file.name}`);
  } else if (looksLikeMP3(url)) {
    startWithSource(url, url);
  } else {
    alert('Please enter a valid .mp3 URL or choose a local MP3 file.');
  }
});

/* ---------- Events ---------- */
audio.addEventListener('play', ()=>{
  if (firstPlayAt === null) firstPlayAt = Date.now();
  lastPlayT = Date.now();

  // Initialize segment at current position
  lastSeg = Math.floor((audio.currentTime || 0) * 10);
  listenedSegments.add(lastSeg);

  pushLog('play');
});

audio.addEventListener('pause', ()=>{
  accountListening();
  lastPlayT = null;
  pushLog('pause');
});

// STRICT coverage: mark only segments actually played (no gap filling across seeks)
audio.addEventListener('timeupdate', ()=>{
  if (audio.paused || firstPlayAt === null) return;

  const seg = Math.floor((audio.currentTime || 0) * 10);

  if (lastSeg === null || lastEventWasSeek) {
    // After a seek, only mark the current segment (do not backfill)
    listenedSegments.add(seg);
    lastSeg = seg;
    lastEventWasSeek = false;
    return;
  }

  if (seg === lastSeg) {
    return; // same 0.1s segment
  } else if (seg > lastSeg) {
    // Normal forward progression while playing:
    // Mark only the current segment; do NOT fill intermediate gaps,
    // because large jumps could be silent/seek skips.
    listenedSegments.add(seg);
    lastSeg = seg;
  } else if (seg < lastSeg) {
    // Rewind occurred during playback
    lastSeg = seg;
    listenedSegments.add(seg);
  }
});

audio.addEventListener('seeking', ()=>{
  // Close listening interval up to this point (if we were playing)
  accountListening();
});
audio.addEventListener('seeked', ()=>{
  lastEventWasSeek = true; // next timeupdate: mark only the immediate segment
  pushLog('seek');
  if (!audio.paused && firstPlayAt !== null) lastPlayT = Date.now();
});

document.getElementById('speedGrid').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-speed]');
  if(!btn) return;
  const s = parseFloat(btn.getAttribute('data-speed'));
  if (!isNaN(s)) {
    accountListening(); // finalize up to speed change if playing
    audio.playbackRate = s;
    if (!audio.paused && firstPlayAt !== null) lastPlayT = Date.now();
    pushLog('speed_change');
  }
});

audio.addEventListener('ended', ()=>{
  // finalize on natural end
  accountListening();
  pushLog('ended');
});

finishBtn.addEventListener('click', ()=>{
  accountListening(); // finalize listening time
  finishedAt = Date.now();
  pushLog('finish');
  downloadCSV();
  finishBtn.disabled = true;
});

/* ---------- CSV & Completion ---------- */
function strictCompletionPercent(){
  const dur = audio.duration || 0;
  if (dur <= 0) return 0;
  const totalSegments = Math.max(1, Math.ceil(dur * 10)); // tenths
  const uniqueListened = Math.min(listenedSegments.size, totalSegments);
  return (uniqueListened / totalSegments) * 100;
}

function downloadCSV(){
  const lines = [];
  lines.push(HEADER.join(','));
  for(const row of logRows) lines.push(row.map(csvEscape).join(','));

  // Overall footer (strict completion)
  if (firstPlayAt !== null && finishedAt !== null) {
    const weightedSpeed = totalListen > 0 ? (speedIntegral / totalListen) : 0;
    const completion = strictCompletionPercent();

    // Footer: student_number, "overall", then metrics in their columns
    const footer = [
      studentTag, 'overall', '', '',               // mp3_url blank, event_type overall
      '', fmt(weightedSpeed), fmt(totalListen), fmt(completion)
    ];
    lines.push(footer.map(csvEscape).join(','));
  }

  const BOM = '\uFEFF';
  const csvText = BOM + lines.join('\r\n');
  const blob = new Blob([csvText], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'listening_log.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- init ---------- */
refreshStartDisabled();
</script>
</body>
</html>
